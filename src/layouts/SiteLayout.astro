---
import "../styles/tailwind.css";
import HeaderBlock from "@/components/blocks/header-1.astro";
import FooterBlock from "@/components/blocks/footer-1.astro";
import SEOBlock from "@/components/blocks/SEO.astro";
import { getSiteSettings, getHeaderMenu, getFooterLinks } from "@/lib/content";

interface HeaderLink {
  icon?: string;
  text?: string;
  href?: string;
  target?: string;
}
interface MenuLink {
  text?: string;
  href?: string;
}
interface Menu {
  text?: string;
  href?: string;
  links?: MenuLink[];
}
interface Logo {
  src?: string;
  alt?: string;
  text?: string;
  href?: string;
}

interface Props {
  lang?: "en" | "es" | "fr";
  title?: string;
  description?: string;
  showHeader?: boolean;
  showFooter?: boolean;
  header?: {
    logo?: Logo;
    menus?: Menu[];
    links?: HeaderLink[];
    socials?: string[];
  };
  footer?: {
    logo?: Logo;
    description?: string;
    menus?: { text?: string; links?: MenuLink[] }[];
    links?: HeaderLink[];
    socials?: string[];
  };
}

const {
  lang = "en",
  title = "Personal Shopper",
  description = "Personal Shopper landing page",
  showHeader = true,
  showFooter = true,
  header,
  footer,
} = Astro.props as Props;

// Remove hardcoded defaults; rely on CMS + optional props

// Load CMS-driven navigation
const site = await getSiteSettings(lang as any).catch(() => undefined);
const headerMenu = await getHeaderMenu(lang as any).catch(() => []);
const footerLinks = await getFooterLinks(lang as any).catch(() => []);

// Map header menu with optional submenus via `parent` linking to parent's slug
const headerChildren = headerMenu
  .filter((i) => i.parent)
  .reduce((acc: Record<string, typeof headerMenu>, item) => {
    const key = item.parent as string
    if (!acc[key]) acc[key] = [] as unknown as typeof headerMenu
    acc[key].push(item)
    return acc
  }, {})

const sortByOrder = <T extends { order?: number }>(arr: T[]) =>
  [...arr].sort((a, b) => (a.order ?? 0) - (b.order ?? 0))

const headerMenusFromCms = sortByOrder(
  headerMenu.filter((i) => !i.parent)
).map((i) => ({
  text: i.text,
  href: i.href,
  links: sortByOrder(headerChildren[i.slug] || []).map((c) => ({
    text: c.text,
    href: c.href,
  })),
}));

// Map footer menus grouped by section
const footerMenusFromCms = Object.values(
  footerLinks.reduce(
    (
      acc: Record<
        string,
        { text: string; links: { text?: string; href?: string }[] }
      >,
      i
    ) => {
      const section = i.section || "Links";
      if (!acc[section]) acc[section] = { text: section, links: [] };
      acc[section].links.push({
        text: i.text,
        href: i.href,
      });
      return acc;
    },
    {}
  )
);

const computedHeader = {
  ...(header || {}),
  menus: headerMenusFromCms.length > 0 ? headerMenusFromCms : header?.menus || [],
  links:
    site?.header_cta_text && site?.header_cta_href
      ? [{ text: site.header_cta_text as string, href: site.header_cta_href as string }]
      : header?.links || [],
};

const computedFooter = {
  ...(footer || {}),
  description: (site?.footer_description as string) || footer?.description,
  menus: footerMenusFromCms.length > 0 ? footerMenusFromCms : footer?.menus || [],
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="light dark" />
    <script is:inline>
      try {
        const storageKey = "theme";
        const stored = localStorage.getItem(storageKey);
        const systemPrefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme =
          stored === "light" || stored === "dark"
            ? stored
            : systemPrefersDark
              ? "dark"
              : "light";
        const root = document.documentElement;
        if (theme === "dark") root.classList.add("dark");
        else root.classList.remove("dark");
        root.style.colorScheme = theme;
      } catch (e) {}
    </script>
    <SEOBlock
      title={title}
      description={description}
      lang={lang}
      ogImage={site?.og_image as string}
      jsonLd={[
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          url: Astro.url.origin,
          name: computedHeader?.logo?.text ?? title ?? "Personal Shopper",
          inLanguage: lang,
        },
        {
          "@context": "https://schema.org",
          "@type": "Person",
          name: computedHeader?.logo?.text ?? "Personal Shopper",
          url: Astro.url.origin,
        },
      ]}
    />
  </head>
  <body class="min-h-screen antialiased">
    {
      showHeader && (
        <HeaderBlock
          {...computedHeader}
          lang={lang}
          path={Astro.url.pathname}
        />
      )
    }
    <slot />
    {showFooter && <FooterBlock {...computedFooter} />}
  </body>
</html>
