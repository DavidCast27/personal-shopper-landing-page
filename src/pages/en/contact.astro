---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getPage } from "@/lib/content";
import { Section } from "@/components/ui/section";
import { Field, FieldLabel, FieldDescription } from "@/components/ui/field";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { actions } from "astro:actions";
 
const page = await getPage('en', 'contact');
const fm = page.frontmatter as { title?: string; description?: string };
---

<SiteLayout
  lang="en"
  title={fm.title}
  description={fm.description}
>
  <Section style="--section-width: 672px;">
    {fm.title && <h1 class="text-2xl font-semibold">{fm.title}</h1>}
    <form
      id="contact-form"
      method="POST"
      action={actions.contact}
      class="mt-6 grid gap-4"
    >
      <input type="hidden" name="lang" value="en" />
      <input
        type="text"
        name="company"
        class="hidden"
        tabindex="-1"
        autocomplete="off"
      />
      <Field>
        <FieldLabel>Name</FieldLabel>
        <Input
          type="text"
          name="name"
          placeholder="Name"
          required
          aria-invalid="false"
          aria-describedby="error-name"
        />
      </Field>
      <Field>
        <FieldLabel>Email</FieldLabel>
        <Input
          type="email"
          name="email"
          placeholder="Email"
          required
          aria-invalid="false"
          aria-describedby="error-email"
        />
      </Field>
      <Field>
        <FieldLabel>Message</FieldLabel>
        <Textarea
          name="message"
          placeholder="Message"
          rows="5"
          required
          aria-invalid="false"
          aria-describedby="error-message"
        />
        <FieldDescription>We reply within 1–2 business days.</FieldDescription>
      </Field>
      <div class="flex items-center gap-3">
        <Button id="submit-btn" type="submit">Send</Button>
        <p
          id="form-status"
          role="status"
          aria-live="polite"
          class="text-sm text-muted-foreground"
        >
        </p>
      </div>
    </form>
  </Section>
</SiteLayout>

<script type="module">
  const form = document.getElementById("contact-form");
  const btn = document.getElementById("submit-btn");
  const statusEl = document.getElementById("form-status");
  const $ = (id) => document.getElementById(id);

  const messages = {
    sending: "Sending…",
    success: "Thanks! We will get back to you soon.",
    genericError: "Something went wrong. Please try again later.",
    networkError: "Network error. Please try again later.",
    rateLimit: "Too many requests. Please try again later.",
    checkFields: "Please check the fields and try again.",
    name_length: "Name must be between 2 and 80 characters.",
    email_invalid: "Please enter a valid email address.",
    message_length: "Message must be between 10 and 2000 characters.",
  };

  function setStatus(msg, kind = "info") {
    statusEl.textContent = msg;
    statusEl.className = `text-sm ${kind === "error" ? "text-red-600" : kind === "success" ? "text-green-600" : "text-muted-foreground"}`;
  }

  function clearErrors() {
    ["name", "email", "message"].forEach((f) => {
      const input = form?.querySelector(`[name="${f}"]`);
      const err = $(`error-${f}`);
      if (input) input.setAttribute("aria-invalid", "false");
      if (err) err.textContent = "";
    });
  }

  function validateLocal(data) {
    const errs = {};
    const name = String(data.name || "").trim();
    const email = String(data.email || "").trim();
    const message = String(data.message || "").trim();
    if (name.length < 2 || name.length > 80) errs.name = "name_length";
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email))
      errs.email = "email_invalid";
    if (message.length < 10 || message.length > 2000)
      errs.message = "message_length";
    return errs;
  }

  function applyErrors(errs) {
    Object.entries(errs).forEach(([field, code]) => {
      const input = form?.querySelector(`[name="${field}"]`);
      const err = $(`error-${field}`);
      if (input) input.setAttribute("aria-invalid", "true");
      if (err) err.textContent = messages[code] || messages.genericError;
    });
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!form) return;
    const data = Object.fromEntries(new FormData(form));
    clearErrors();
    const localErrs = validateLocal(data);
    if (Object.keys(localErrs).length) {
      applyErrors(localErrs);
      setStatus(messages.checkFields, "error");
      return;
    }
    setStatus(messages.sending);
    btn?.setAttribute("disabled", "true");
    try {
      const res = await fetch(form.action, {
        method: "POST",
        headers: { "X-Requested-With": "fetch", Accept: "application/json" },
        body: new FormData(form),
      });
      const json = await res.json().catch(() => ({}));
      const error = json?.error;
      const cause = json?.errors || json?.cause || error?.cause || {};
      const message = json?.message || error?.message;
      const success =
        json?.ok === true || json?.data?.ok === true || (!error && res.ok);
      if (success) {
        setStatus(messages.success, "success");
        form.reset();
        statusEl?.focus?.();
      } else if (res.status === 400 && cause && Object.keys(cause).length) {
        applyErrors(cause);
        setStatus(messages.checkFields, "error");
      } else if (res.status === 429 || message === "rate_limited") {
        setStatus(messages.rateLimit, "error");
      } else {
        setStatus(messages.genericError, "error");
      }
    } catch (err) {
      setStatus(messages.networkError, "error");
    } finally {
      btn?.removeAttribute("disabled");
    }
  });
</script>
