---
import SiteLayout from "../../../layouts/SiteLayout.astro";
import ArticleBlock from "@/components/blocks/article-1.astro";
import { getBlogPosts, getPost } from "@/lib/content";
import { renderMarkdown } from "@/lib/markdown";
import { t } from "@/lib/i18n";
import { staticPathsForSlugs, type Lang } from "@/lib/lang";

export const prerender = true;

export async function getStaticPaths() {
  return staticPathsForSlugs(getBlogPosts)
}

const placeholderImage = "/uploads/image-placeholder.daj0efyq_29eycw.webp";

const { lang, slug } = Astro.params as { lang: Lang; slug: string };
const post = await getPost(lang, slug);
const title = post.title;
const origin = Astro.url.origin;
const canonical = new URL(Astro.url.pathname, origin).toString();

function abs(u?: string) {
  if (!u) return undefined;
  try { new URL(u); return u; } catch {}
  try { return new URL(u, origin).toString(); } catch { return undefined; }
}

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: post.description || "",
  image: abs(post.image),
  datePublished: post.frontmatter?.date || undefined,
  dateModified: post.frontmatter?.date || undefined,
  inLanguage: lang,
  mainEntityOfPage: canonical,
  author: { "@type": "Organization", name: "Personal Shopper" },
  publisher: { "@type": "Organization", name: "Personal Shopper" },
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: t(lang, 'breadcrumb.home'), item: new URL(`/${lang}/`, origin).toString() },
    { "@type": "ListItem", position: 2, name: t(lang, 'breadcrumb.blog'), item: new URL(`/${lang}/blog/`, origin).toString() },
    { "@type": "ListItem", position: 3, name: title, item: canonical },
  ],
};
---

<SiteLayout
  lang={lang}
  title={`${title} â€“ Personal Shopper`}
  description={post.description || ''}
  jsonLd={[articleJsonLd, breadcrumbJsonLd]}
>
  <ArticleBlock
    title={title}
    description={post.description || ""}
    image={{
      src: post.image ?? placeholderImage,
      alt: title,
      width: 672,
      height: 378,
    }}
    item={{
      title: t(lang, 'article.author'),
      description: "",
      image: { src: placeholderImage, alt: "" },
    }}
  >
    <div class="prose prose-neutral max-w-none" set:html={renderMarkdown(post.body)} />
  </ArticleBlock>
</SiteLayout>
